<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text Portrait Builder</title>
    <style>
      :root {
        --bg: #0f1116;
        --panel: #1a1f29;
        --panel-light: #232b3a;
        --text: #e5e9f0;
        --muted: #95a0b5;
        --accent: #7aa2ff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Fira Code", "Consolas", monospace;
        background: radial-gradient(circle at top, #1d2433, var(--bg) 55%);
        color: var(--text);
        display: grid;
        grid-template-columns: 1fr 1fr;
      }

      .panel {
        padding: 20px;
        border-right: 1px solid #2c3443;
      }

      .panel:last-child {
        border-right: 0;
      }

      .title {
        margin: 0 0 12px;
        font-size: 16px;
        letter-spacing: 0.03em;
        color: var(--accent);
      }

      .controls {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid #303949;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 14px;
      }

      label {
        display: block;
        color: var(--muted);
        margin-bottom: 6px;
        font-size: 12px;
      }

      input,
      textarea,
      button {
        width: 100%;
        border: 1px solid #364157;
        background: var(--panel);
        color: var(--text);
        border-radius: 8px;
        padding: 10px;
        font: inherit;
      }

      textarea {
        min-height: 160px;
        resize: vertical;
        line-height: 1.45;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 8px;
      }

      button {
        cursor: pointer;
        background: linear-gradient(180deg, #2f3a52, #243048);
      }

      button:hover {
        filter: brightness(1.08);
      }

      .art-frame {
        border: 1px solid #2f3a4d;
        border-radius: 10px;
        background: #0b0e14;
        overflow: auto;
        height: calc(100vh - 130px);
      }

      #textArt {
        margin: 0;
        padding: 10px;
        white-space: pre;
        line-height: 0.64;
        font-size: 7.4px;
        letter-spacing: 0.07em;
        color: #ddd;
      }

      .code-view {
        border: 1px solid #303949;
        border-radius: 10px;
        background: #11151d;
        height: calc(100vh - 80px);
        overflow: auto;
        padding: 14px;
      }

      .code-view code {
        color: #dbe5ff;
        font-size: 12px;
        white-space: pre;
        display: block;
      }

      @media (max-width: 980px) {
        body {
          grid-template-columns: 1fr;
        }

        .panel {
          border-right: 0;
          border-bottom: 1px solid #2c3443;
        }

        .art-frame,
        .code-view {
          height: 55vh;
        }
      }
    </style>
  </head>
  <body>
    <section class="panel">
      <h2 class="title">Preview — text portrait</h2>
      <div class="art-frame">
        <pre id="textArt">Load a face image and click “Build Portrait”.</pre>
      </div>
    </section>

    <section class="panel">
      <h2 class="title">Source — text + controls</h2>
      <div class="controls">
        <label for="imageInput">Reference face image</label>
        <input id="imageInput" type="file" accept="image/*" />

        <div class="grid">
          <div>
            <label for="widthInput">Columns</label>
            <input id="widthInput" type="number" value="120" min="40" max="220" />
          </div>
          <div>
            <label for="contrastInput">Contrast boost</label>
            <input id="contrastInput" type="number" value="1.25" step="0.05" min="0.4" max="3" />
          </div>
        </div>

        <label for="textInput" style="margin-top: 10px">Text to draw with (lyrics, message, etc.)</label>
        <textarea id="textInput">
Every night I feel this light
You and me, just side by side
All my words become your name
In this little text-made frame
        </textarea>

        <div class="grid">
          <button id="buildBtn">Build Portrait</button>
          <button id="copyBtn">Copy HTML snippet</button>
        </div>
      </div>

      <div class="code-view">
        <code id="codeOutput"></code>
      </div>
    </section>

    <canvas id="canvas" hidden></canvas>

    <script>
      const imageInput = document.getElementById("imageInput");
      const textInput = document.getElementById("textInput");
      const widthInput = document.getElementById("widthInput");
      const contrastInput = document.getElementById("contrastInput");
      const buildBtn = document.getElementById("buildBtn");
      const copyBtn = document.getElementById("copyBtn");
      const textArt = document.getElementById("textArt");
      const codeOutput = document.getElementById("codeOutput");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      let uploadedImage = null;

      imageInput.addEventListener("change", (event) => {
        const [file] = event.target.files;
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            uploadedImage = img;
            buildPortrait();
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });

      buildBtn.addEventListener("click", buildPortrait);

      copyBtn.addEventListener("click", async () => {
        const snippet = `<pre style="font-size:7px;line-height:0.64;white-space:pre">${escapeHtml(
          textArt.textContent
        )}</pre>`;
        await navigator.clipboard.writeText(snippet);
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = "Copy HTML snippet"), 1200);
      });

      function buildPortrait() {
        if (!uploadedImage) {
          textArt.textContent = "Upload an image first, then we can shape the face using your text.";
          renderCodePreview();
          return;
        }

        const sourceText = textInput.value.replace(/\s+/g, " ").trim() || "LOVE";
        const columns = Number(widthInput.value) || 120;
        const contrast = Number(contrastInput.value) || 1.25;
        const aspectRatio = uploadedImage.height / uploadedImage.width;
        const rows = Math.max(20, Math.floor(columns * aspectRatio * 0.53));

        canvas.width = columns;
        canvas.height = rows;

        ctx.filter = `grayscale(1) contrast(${contrast})`;
        ctx.drawImage(uploadedImage, 0, 0, columns, rows);
        ctx.filter = "none";

        const data = ctx.getImageData(0, 0, columns, rows).data;
        const shades = " .,:;+=xX$#";

        let textPointer = 0;
        let ascii = "";

        for (let y = 0; y < rows; y++) {
          for (let x = 0; x < columns; x++) {
            const i = (y * columns + x) * 4;
            const brightness = data[i];
            const shadeIndex = Math.floor((brightness / 255) * (shades.length - 1));

            if (brightness < 245) {
              const char = sourceText[textPointer % sourceText.length];
              textPointer++;
              ascii += char === " " ? shades[shadeIndex] : char;
            } else {
              ascii += shades[shadeIndex];
            }
          }
          ascii += "\n";
        }

        textArt.textContent = ascii;
        renderCodePreview(sourceText, columns, contrast, rows);
      }

      function renderCodePreview(sourceText = "", columns = 120, contrast = 1.25, rows = 0) {
        codeOutput.textContent = `// Paste your own image and text content to regenerate
const settings = {
  columns: ${columns},
  contrast: ${contrast},
  approxRows: ${rows}
};

const textContent = ${JSON.stringify(sourceText)};

// Result preview:
${textArt.textContent.slice(0, 1800)}${textArt.textContent.length > 1800 ? "\n..." : ""}`;
      }

      function escapeHtml(value) {
        return value
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      renderCodePreview();
    </script>
  </body>
</html>
